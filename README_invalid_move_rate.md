# Invalid Move Rate Metric

This document describes the implementation of the `invalid_move_rate` metric in the boardGPT project.

## Overview

The `invalid_move_rate` function computes the rate of invalid moves generated by a model. It:

1. Takes a training or validation set
2. Uses a model to generate the next move given a sequence of previous moves
3. Checks if the generated move is valid
4. Computes the rate of invalid moves over the given set

## Implementation

The function is implemented in `boardGPT/validation/metrics.py`. It has the following signature:

```python
def invalid_move_rate(
    model,
    data_dir: str,
    split: str = "val",
    data_filename: str = "val.pkl",
    num_samples: int = 1000,
    max_new_tokens: int = 1,
    temperature: float = 1.0,
    top_k: int = None
) -> float:
    """
    Compute the average rate of invalid moves generated by a model.
    
    Args:
        model: The model to evaluate
        data_dir (str): Directory containing the dataset
        split (str): Dataset split to use ("train" or "val")
        data_filename (str): Filename for the dataset
        num_samples (int): Number of samples to evaluate
        max_new_tokens (int): Number of new tokens to generate
        temperature (float): Temperature for sampling
        top_k (int): Top-k sampling parameter
        
    Returns:
        float: Average rate of invalid moves
    """
```

## Usage

Here's an example of how to use the `invalid_move_rate` function:

```python
from boardGPT.validation.metrics import invalid_move_rate
from boardGPT.nn.gpt import GPT

# Load the model
model = GPT.from_pretrained('othello')
model.load_safetensors('/path/to/model/checkpoint.safetensors')
model.eval()

# Compute the invalid move rate
rate = invalid_move_rate(
   model=model,
   data_dir='data',
   split='val',
   data_filename='val.pkl',
   num_samples=100,
   temperature=1.0,
   top_k=None
)

print(f"Invalid move rate: {rate:.4f}")
```

## Test Script

A test script is provided to demonstrate the usage of the `invalid_move_rate` function. You can run it with:

```bash
python test_invalid_move_rate.py --model_path /path/to/model/checkpoint.safetensors
```

Additional command-line arguments:
- `--data_dir`: Directory containing the dataset (default: 'data')
- `--split`: Dataset split to use ('train' or 'val') (default: 'val')
- `--data_filename`: Filename for the dataset (default: 'val.pkl')
- `--num_samples`: Number of samples to evaluate (default: 100)
- `--temperature`: Temperature for sampling (default: 1.0)
- `--top_k`: Top-k sampling parameter (default: None)

## Implementation Details

The function works as follows:

1. Loads the dataset using `load_othello_dataset`
2. Randomly samples sequences from the dataset
3. For each sequence:
   - Chooses a random length for the opening moves
   - Converts the opening moves from IDs to move notation
   - Uses the model to generate the next move
   - Converts the generated move from notation to ID
   - Checks if the generated move is valid using the `is_valid` function
   - Counts the number of invalid moves
4. Computes the rate of invalid moves as the ratio of invalid moves to total moves

The `is_valid` function checks if a move is valid given a sequence of previous moves by:
1. Converting move IDs to move notation
2. Creating a new Othello game
3. Applying all previous moves to the game
4. Checking if the new move is valid